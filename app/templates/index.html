<script>
    var ctx = document.getElementById('pmChart').getContext('2d');
    var colors = {
        'pm25': 'rgba(75,192,192,1)',
        'pm10': 'rgba(255,99,132,1)',
        'o3': 'rgba(255,206,86,1)'
    };

    var datasets = Object.keys(colors).map(function (k) {
        return { label: k.toUpperCase(), data: [], borderColor: colors[k], fill: false };
    });

    var pmChart = new Chart(ctx, {
        type: 'line',
        data: { labels: [], datasets: datasets },
        options: {
            responsive: true,
            scales: {
                xAxes: [{ display: true }],
                yAxes: [{ display: true, ticks: { beginAtZero: true } }]
            }
        }
    });

    var socket = io.connect('http://' + document.domain + ':' + location.port);
    socket.on('new_data', function (data) {
        var grouped = {};
        data.forEach(function (item) {
            if (!grouped[item.parameter]) grouped[item.parameter] = [];
            grouped[item.parameter].push(item.value);
        });

        pmChart.data.labels = Object.keys(grouped.pm25 || {}).map(String);

        pmChart.data.datasets.forEach(function (ds) {
            ds.data = grouped[ds.label.toLowerCase()] || [];
        });
        pmChart.update();
    });
</script>